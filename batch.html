<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Batch Management - Ruby Auto Parts</title>
  <script>
    // Check authentication
    if (sessionStorage.getItem('rubyAutoPartsLoggedIn') !== 'true') {
      window.location.href = 'login.html';
    }
    
    function logout() {
      sessionStorage.removeItem('rubyAutoPartsLoggedIn');
      sessionStorage.removeItem('rubyAutoPartsUser');
      sessionStorage.removeItem('currentBatch');
      window.location.href = 'login.html';
    }
    
    function resetBatch() {
      if (confirm("Are you sure you want to reset the current batch? This will clear the current batch session but keep all existing product batch information.")) {
        sessionStorage.removeItem('currentBatch');
        sessionStorage.removeItem('currentVendor');
        // Don't clear batchTracking - this keeps the relationship between products and batches
        alert("Current batch reset successfully. All existing products will retain their batch information. You can now create a new batch.");
        location.reload();
      }
    }
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #fff;
      margin: 0;
      padding: 2rem;
      color: #000;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #eee;
    }
    .header h1 {
      margin: 0;
      color: #333;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .user-info span {
      color: #666;
      font-size: 0.9rem;
    }
    .logout-btn {
      background-color: #e74c3c;
      color: #fff;
      border: 1px solid #e74c3c;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .logout-btn:hover {
      background-color: #c0392b;
      border-color: #c0392b;
    }
    .reset-btn {
      background-color: #f39c12;
      color: #fff;
      border: 1px solid #f39c12;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .reset-btn:hover {
      background-color: #e67e22;
      border-color: #e67e22;
    }
    h2 {
      margin-bottom: 1rem;
    }
    .batch-info {
      background-color: #e8f5e8;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      border: 1px solid #4caf50;
    }
    .batch-info h3 {
      margin: 0 0 0.5rem 0;
      color: #2e7d32;
    }
    .batch-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .batch-detail {
      display: flex;
      flex-direction: column;
    }
    .batch-detail strong {
      color: #2e7d32;
      font-size: 0.9rem;
    }
    .batch-detail span {
      color: #333;
      font-size: 1rem;
    }
    form {
      background-color: #fff;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      border: 1px solid #999;
    }
    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.8rem;
    }
    .form-row input, .form-row select {
      flex: 1;
      padding: 0.5rem;
      font-size: 0.9rem;
      border: 1px solid #999;
      border-radius: 4px;
      background: #fff;
      color: #000;
    }
    .form-row.full-width {
      flex-direction: column;
    }
    .form-row.full-width input {
      width: 100%;
    }
    button {
      background-color: #000;
      color: #fff;
      border: 1px solid #000;
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background-color: #555;
      border-color: #555;
    }
    .search-section {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      border: 1px solid #dee2e6;
    }
    .search-section h3 {
      margin-top: 0;
      color: #495057;
    }
    .search-input-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .search-input-group input {
      flex: 1;
      padding: 0.5rem;
      font-size: 0.9rem;
      border: 1px solid #999;
      border-radius: 4px;
      background: #fff;
      color: #000;
    }
    .search-btn {
      background-color: #007bff;
      color: #fff;
      border: 1px solid #007bff;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .search-btn:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    #vendorResults {
      margin-top: 1rem;
      padding: 1rem;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: none;
    }
    .vendor-item {
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .vendor-item:hover {
      background-color: #f8f9fa;
    }
    .vendor-item:last-child {
      border-bottom: none;
    }
    .vendor-name {
      font-weight: bold;
      color: #333;
    }
    .vendor-details {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.2rem;
    }
    .navigation {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }
    .nav-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .add-stock-btn {
      background-color: #28a745;
      border-color: #28a745;
    }
    .add-stock-btn:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }
    .add-stock-btn:disabled {
      background-color: #6c757d;
      border-color: #6c757d;
      cursor: not-allowed;
    }
    .workflow-info {
      border: 1px solid #2196f3;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .workflow-info p {
      margin: 0.5rem 0;
      color: #1976d2;
      font-size: 0.95rem;
    }
    .workflow-info p:first-child {
      font-weight: 600;
    }
    
    .batch-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .refresh-btn, .toggle-btn {
      padding: 0.5rem 1rem;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .refresh-btn:hover, .toggle-btn:hover {
      background: #2980b9;
    }
    
    .batches-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }
    
    .batch-item {
      padding: 1rem;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .batch-item:hover {
      background-color: #f8f9fa;
    }
    
    .batch-item:last-child {
      border-bottom: none;
    }
    
    .batch-item.active {
      background-color: #e8f5e8;
      border-left: 4px solid #27ae60;
    }
    
    .batch-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .batch-id {
      font-weight: bold;
      color: #2c3e50;
    }
    
    .batch-date {
      font-size: 0.9rem;
      color: #666;
    }
    
    .batch-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }
    
    .batch-details.hidden {
      display: none;
    }
    
    .loading-message {
      text-align: center;
      padding: 2rem;
      color: #666;
      font-style: italic;
    }
    
    .empty-message {
      text-align: center;
      padding: 2rem;
      color: #999;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
  <!-- Navigation -->
  <nav style="background: #2c3e50; color: white; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <h2 style="margin: 0; font-size: 1.2rem;">üè¢ Ruby Auto Parts</h2>
        <span style="font-size: 0.9rem; color: #bdc3c7;">Batch Management</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 0.9rem;">Welcome, <strong id="currentUser">admin</strong></span>
        <button onclick="resetBatch()" style="background: #f39c12; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Reset Batch</button>
        <button onclick="logout()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Logout</button>
      </div>
    </div>
    
    <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
      <a href="inventory.html" style="background: #3498db; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üì¶ Add Inventory</a>
      <a href="inventory-list.html" style="background: #2c3e50; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üìã Inventory List</a>
      <a href="batch.html" style="background: #9b59b6; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üìã Batch Management</a>
      <a href="active-inventory.html" style="background: #27ae60; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">‚úÖ Active Stock</a>
      <a href="onhold-inventory.html" style="background: #f39c12; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">‚è∏Ô∏è On-Hold Stock</a>
      <a href="billing.html" style="background: #e67e22; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üí∞ Billing</a>
      <a href="activate.html" style="background: #1abc9c; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üîÑ Activate</a>
      <a href="audit.html" style="background: #6f42c1; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üîç Audit</a>
      <a href="add-product.html" style="background: #17a2b8; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">‚ûï Add Product</a>
      <a href="metrics.html" style="background: #8e44ad; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üìä Metrics</a>
    </div>
  </nav>

  <div id="batchInfo" class="batch-info" style="display: none;">
    <h3>Current Batch Information</h3>
    <div class="batch-details">
      <div class="batch-detail">
        <strong>Batch ID:</strong>
        <span id="currentBatchId">-</span>
      </div>
      <div class="batch-detail">
        <strong>Vendor Name:</strong>
        <span id="currentVendorName">-</span>
      </div>
      <div class="batch-detail">
        <strong>Invoice Number:</strong>
        <span id="currentInvoiceNumber">-</span>
      </div>
      <div class="batch-detail">
        <strong>Created:</strong>
        <span id="currentTimestamp">-</span>
      </div>
    </div>
  </div>

  <div class="search-section">
    <h3>Search Vendor Details</h3>
    <p>Scan or enter barcode to search for vendor information:</p>
    <div class="search-input-group">
      <input type="text" id="searchInput" placeholder="Enter or scan barcode...">
      <button id="searchBtn" class="search-btn">Search</button>
    </div>
    <div id="vendorResults"></div>
  </div>

  <div class="section">
    <h2>Existing Batches</h2>
    <div class="batch-controls">
      <button id="refreshBatchesBtn" class="refresh-btn">üîÑ Refresh List</button>
      <button id="toggleBatchViewBtn" class="toggle-btn">üìã Show Details</button>
    </div>
    <div id="batchesList" class="batches-list">
      <div class="loading-message">Loading batches...</div>
    </div>
  </div>

  <div id="newBatchForm" class="form-section">
    <h2>Create New Batch</h2>
    <div class="workflow-info">
      <p><strong>üìã New Workflow:</strong> Create a batch first, then add inventory items to it.</p>
      <p>This ensures proper tracking of vendor information and batch management.</p>
    </div>
    <form id="batchForm">
      <div class="form-row">
        <input type="text" id="vendorName" placeholder="Vendor Name" required>
        <input type="text" id="invoiceNumber" placeholder="Invoice Number" required>
      </div>
      <button type="submit">Create New Batch</button>
    </form>
  </div>

  <div class="navigation">
    <h3>Quick Actions</h3>
    <div class="nav-buttons">
      <button id="addStockBtn" class="add-stock-btn" onclick="goToInventory()" disabled>Add Stock Items</button>
      <button onclick="window.location.href='inventory-list.html'">View Inventory</button>
      <button onclick="window.location.href='active-inventory.html'">Active Inventory</button>
      <button onclick="window.location.href='onhold-inventory.html'">On-Hold Inventory</button>
    </div>
  </div>
  
  <script type="module">
    import { supabase } from './src/database.js'
    
    // Wait for DOM to load
    function initializeApp() {
      // Set current user
      document.getElementById('currentUser').textContent = sessionStorage.getItem('rubyAutoPartsUser') || 'admin';

      // Check if batch already exists
      const currentBatch = sessionStorage.getItem('currentBatch');
      if (currentBatch) {
        displayBatchInfo(JSON.parse(currentBatch));
      }
      
      // Load existing batches
      loadBatches();
      
      // Add event listeners for batch controls
      document.getElementById('refreshBatchesBtn').addEventListener('click', loadBatches);
      document.getElementById('toggleBatchViewBtn').addEventListener('click', toggleBatchDetails);

    // Create new batch
    document.getElementById('batchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const vendorName = document.getElementById('vendorName').value.trim();
      const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
      
      if (!vendorName || !invoiceNumber) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        // Create batch in database
        const now = new Date();
        const { data: newBatch, error } = await supabase()
          .from('batches')
          .insert([{
            batch_id: `${invoiceNumber}-${vendorName}-${Date.now()}`,
            batch_date: now.toISOString().split('T')[0],
            batch_time: now.toTimeString().split(' ')[0],
            vendor_name: vendorName,
            vendor_invoice: invoiceNumber,
            created_by: sessionStorage.getItem('rubyAutoPartsUser') || 'admin'
          }])
          .select()
          .single();

        if (error) throw error;

        const batchData = {
          id: newBatch.id,
          batchId: newBatch.batch_id,
          vendorName: newBatch.vendor_name,
          invoiceNumber: newBatch.vendor_invoice,
          timestamp: newBatch.created_at,
          created: new Date(newBatch.created_at).toLocaleString('en-IN', {
            timeZone: 'Asia/Kolkata',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })
        };

        // Store batch in session storage
        sessionStorage.setItem('currentBatch', JSON.stringify(batchData));
        sessionStorage.setItem('currentVendor', JSON.stringify({
          name: vendorName,
          invoiceNumber: invoiceNumber
        }));

        displayBatchInfo(batchData);
        
        // Refresh the batches list
        loadBatches();
        
        // Clear the form
        document.getElementById('vendorName').value = '';
        document.getElementById('invoiceNumber').value = '';
        
        alert(`Batch created successfully!\nBatch ID: ${batchData.batchId}\n\nYou can now add stock items for this vendor.`);
        
      } catch (error) {
        console.error('Error creating batch:', error);
        alert('Error creating batch. Please try again.');
      }
    });

    function displayBatchInfo(batchData) {
      document.getElementById('currentBatchId').textContent = batchData.batchId;
      document.getElementById('currentVendorName').textContent = batchData.vendorName;
      document.getElementById('currentInvoiceNumber').textContent = batchData.invoiceNumber;
      document.getElementById('currentTimestamp').textContent = batchData.created;
      
      document.getElementById('batchInfo').style.display = 'block';
      document.getElementById('newBatchForm').style.display = 'none';
      document.getElementById('addStockBtn').disabled = false;
    }

    async function searchVendor() {
      const query = document.getElementById('searchInput').value.trim();
      const resultsDiv = document.getElementById('vendorResults');
      
      if (query.length < 1) {
        resultsDiv.style.display = 'none';
        return;
      }

      try {
        // Search for inventory items with matching barcode
        const { data, error } = await supabase()
          .from('inventory')
          .select(`
            barcode,
            quantity_active,
            quantity_on_hold,
            products!inner(
              part_name,
              variant,
              brand,
              class,
              price
            ),
            batches!inner(
              batch_id,
              batch_date,
              vendor_name,
              vendor_invoice
            )
          `)
          .eq('barcode', query)
          .limit(10);
          
        console.log('Database query result:', data);

        if (error) throw error;

        if (data && data.length > 0) {
          resultsDiv.innerHTML = '';
          
          // Debug: Log the first product to see what data we're getting
          console.log('Search result sample:', data[0]);
          
          // Show search summary
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'vendor-item';
          summaryDiv.style.backgroundColor = '#e8f5e8';
          summaryDiv.style.border = '1px solid #4caf50';
          summaryDiv.innerHTML = `
            <div class="vendor-name">üîç Search Results for: "${query}"</div>
            <div class="vendor-details">
              <strong>Found ${data.length} product(s)</strong>
            </div>
          `;
          resultsDiv.appendChild(summaryDiv);
          
          data.forEach(item => {
            // Get vendor info from nested data structure
            const product = item.products;
            const batch = item.batches;
            let vendorInfo = batch?.vendor_name || '';
            let batchInfo = batch?.batch_id || '';
            
            // Try localStorage first (persistent), then sessionStorage for additional tracking
            let batchTracking = localStorage.getItem('batchTracking');
            if (!batchTracking) {
              batchTracking = sessionStorage.getItem('batchTracking');
            }
            
            if (batchTracking) {
              const tracking = JSON.parse(batchTracking);
              const trackingData = tracking[item.barcode];
              if (trackingData) {
                vendorInfo = trackingData.vendorName || vendorInfo;
                batchInfo = trackingData.batchId || batchInfo;
              }
            }
            
            if (!vendorInfo) {
              vendorInfo = extractVendorFromBarcode(item.barcode);
            }
            
            // Try to get more detailed vendor info from current batch
            const currentBatch = sessionStorage.getItem('currentBatch');
            if (currentBatch && !vendorInfo) {
              const batchData = JSON.parse(currentBatch);
              vendorInfo = batchData.vendorName;
            }

            // Format the date properly
            let formattedDate = 'Unknown';
            const dateToUse = batch?.batch_date || item.created_at;
            console.log('Item date:', dateToUse, 'Type:', typeof dateToUse);
            
            if (dateToUse) {
              try {
                const date = new Date(dateToUse);
                console.log('Parsed date:', date, 'Is valid:', !isNaN(date.getTime()));
                if (!isNaN(date.getTime())) {
                  formattedDate = date.toLocaleString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  });
                  console.log('Formatted date:', formattedDate);
                } else {
                  // Try alternative date parsing
                  const altDate = new Date(dateToUse + 'T00:00:00');
                  if (!isNaN(altDate.getTime())) {
                    formattedDate = altDate.toLocaleString('en-IN', {
                      timeZone: 'Asia/Kolkata',
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric'
                    });
                    console.log('Alternative formatted date:', formattedDate);
                  }
                }
              } catch (error) {
                console.log('Date formatting error:', error, 'Raw date:', dateToUse);
                formattedDate = dateToUse || 'Invalid date'; // Show raw value if formatting fails
              }
            } else {
              console.log('No date field found for item:', product?.part_name);
              // Fallback to current date if no date is available
              formattedDate = new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              });
            }

            const vendorDiv = document.createElement('div');
            vendorDiv.className = 'vendor-item';
            vendorDiv.innerHTML = `
              <div class="vendor-name">${product?.part_name || 'Unknown Product'} (${product?.variant || ''})</div>
              <div class="vendor-details">
                <strong>Brand:</strong> ${product?.brand || 'Unknown'} | 
                <strong>Class:</strong> ${product?.class || '-'} | 
                <strong>Price:</strong> ‚Çπ${product?.price || '0'} | 
                <strong>Qty:</strong> ${(item.quantity_on_hold + item.quantity_active)}
                <br><strong>Barcode:</strong> ${item.barcode}
                ${vendorInfo ? `<br><strong>Vendor:</strong> ${vendorInfo}` : '<br><strong>Vendor:</strong> Not available'}
                ${batchInfo ? `<br><strong>Batch ID:</strong> ${batchInfo}` : ''}
                <br><strong>Date Added:</strong> ${formattedDate}
              </div>
            `;
            vendorDiv.onclick = () => {
              document.getElementById('searchInput').value = item.barcode;
              resultsDiv.style.display = 'none';
            };
            resultsDiv.appendChild(vendorDiv);
          });
          resultsDiv.style.display = 'block';
        } else {
          resultsDiv.innerHTML = '<div class="vendor-item">No products found with this barcode.</div>';
          resultsDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Search error:', error);
        resultsDiv.innerHTML = '<div class="vendor-item">Error searching for vendor details.</div>';
        resultsDiv.style.display = 'block';
      }
    }

    function extractVendorFromBarcode(barcode) {
      if (!barcode) return null;
      // Barcode format: RANDOMCODE-VENDOR-INVOICE
      const parts = barcode.split('-');
      if (parts.length >= 2) {
        return parts[1];
      }
      return null;
    }

    function goToInventory() {
      if (!sessionStorage.getItem('currentBatch')) {
        alert('Please create a batch first.');
        return;
      }
      window.location.href = 'inventory.html';
    }

    // Add search button event listener
    document.getElementById('searchBtn').addEventListener('click', searchVendor);

    // Add Enter key support for search
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchVendor();
      }
    });

    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-section')) {
        document.getElementById('vendorResults').style.display = 'none';
      }
    });
    } // End of initializeApp function
    
    // Load existing batches from database
    async function loadBatches() {
      const batchesList = document.getElementById('batchesList');
      batchesList.innerHTML = '<div class="loading-message">Loading batches...</div>';
      
      try {
        const { data: batches, error } = await supabase()
          .from('batches')
          .select('*')
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        if (!batches || batches.length === 0) {
          batchesList.innerHTML = '<div class="empty-message">No batches found. Create your first batch above!</div>';
          return;
        }
        
        // Get current batch for highlighting
        const currentBatch = sessionStorage.getItem('currentBatch');
        const currentBatchId = currentBatch ? JSON.parse(currentBatch).id : null;
        
        batchesList.innerHTML = batches.map(batch => {
          const isActive = currentBatchId === batch.id;
          const createdDate = new Date(batch.created_at).toLocaleString('en-IN', {
            timeZone: 'Asia/Kolkata',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          return `
            <div class="batch-item ${isActive ? 'active' : ''}" data-batch-id="${batch.id}">
              <div class="batch-header">
                <div class="batch-id">Batch #${batch.batch_id}</div>
                <div class="batch-date">${createdDate}</div>
              </div>
              <div class="batch-details hidden">
                <div><strong>Vendor:</strong> ${batch.vendor_name || 'Not specified'}</div>
                <div><strong>Invoice:</strong> ${batch.vendor_invoice || 'Not specified'}</div>
                <div><strong>Status:</strong> ${isActive ? 'Active' : 'Inactive'}</div>
                <div><strong>ID:</strong> ${batch.id}</div>
              </div>
            </div>
          `;
        }).join('');
        
        // Add click handlers for batch items
        document.querySelectorAll('.batch-item').forEach(item => {
          item.addEventListener('click', () => selectBatch(item.dataset.batchId));
        });
        
      } catch (error) {
        console.error('Error loading batches:', error);
        batchesList.innerHTML = '<div class="empty-message">Error loading batches. Please try again.</div>';
      }
    }
    
    // Toggle batch details visibility
    function toggleBatchDetails() {
      const details = document.querySelectorAll('.batch-details');
      const button = document.getElementById('toggleBatchViewBtn');
      
      const isHidden = details[0]?.classList.contains('hidden');
      
      details.forEach(detail => {
        if (isHidden) {
          detail.classList.remove('hidden');
        } else {
          detail.classList.add('hidden');
        }
      });
      
      button.textContent = isHidden ? 'üìã Hide Details' : 'üìã Show Details';
    }
    
    // Select a batch and set it as current
    async function selectBatch(batchId) {
      try {
        const { data: batch, error } = await supabase()
          .from('batches')
          .select('*')
          .eq('id', batchId)
          .single();
          
        if (error) throw error;
        
        if (batch) {
          // Set as current batch
          const batchInfo = {
            id: batch.id,
            batchId: batch.batch_id,
            vendorName: batch.vendor_name,
            invoiceNumber: batch.vendor_invoice,
            createdAt: batch.created_at
          };
          
          sessionStorage.setItem('currentBatch', JSON.stringify(batchInfo));
          displayBatchInfo(batchInfo);
          
          // Update UI
          document.querySelectorAll('.batch-item').forEach(item => {
            item.classList.remove('active');
          });
          document.querySelector(`[data-batch-id="${batchId}"]`).classList.add('active');
          
          // Enable add stock button
          document.getElementById('addStockBtn').disabled = false;
        }
      } catch (error) {
        console.error('Error selecting batch:', error);
        alert('Error selecting batch. Please try again.');
      }
    }
    
    // Start the app when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
