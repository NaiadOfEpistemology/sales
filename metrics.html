<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Metrics - Ruby Auto Parts</title>
<script>
  // Check authentication
  if (sessionStorage.getItem('rubyAutoPartsLoggedIn') !== 'true') {
    window.location.href = 'login.html';
  }
  
  function logout() {
    sessionStorage.removeItem('rubyAutoPartsLoggedIn');
    sessionStorage.removeItem('rubyAutoPartsUser');
    window.location.href = 'login.html';
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #fff;
    margin: 0;
    padding: 2rem;
    color: #000;
  }
  h1 {
    text-align: center;
    margin-bottom: 2rem;
  }
  .section {
    background: #fff;
    padding: 1rem;
    margin-bottom: 2rem;
    border: 1px solid #999;
    border-radius: 4px;
  }
  .section h2 {
    margin-bottom: 1rem;
    border-bottom: 1px solid #999;
    padding-bottom: 0.5rem;
  }
  canvas {
    max-width: 100%;
    margin-top: 1rem;
  }
  #inventoryTable, #billsTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    font-size: 0.95rem;
  }
  #inventoryTable th, #inventoryTable td,
  #billsTable th, #billsTable td {
    border: 1px solid #999;
    padding: 0.5rem;
    text-align: left;
  }
  #inventoryTable input {
    width: 60px;
    padding: 2px;
    border: 1px solid #999;
    background: #fff;
    color: #000;
  }
  button {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    background: #000;
    color: #fff;
    border: 1px solid #000;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #555;
    border-color: #555;
  }
  .kpi-cards {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }
  .kpi {
    flex: 1;
    background: #fff;
    padding: 1rem;
    border: 1px solid #999;
    text-align: center;
  }
  </style>
</head>
<body>
<!-- Navigation -->
<nav style="background: #2c3e50; color: white; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <h2 style="margin: 0; font-size: 1.2rem;">üè¢ Ruby Auto Parts</h2>
      <span style="font-size: 0.9rem; color: #bdc3c7;">Analytics & Metrics</span>
    </div>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <span style="font-size: 0.9rem;">Welcome, <strong id="currentUser">admin</strong></span>
      <button onclick="logout()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Logout</button>
    </div>
  </div>
  
  <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
    <a href="inventory.html" style="background: #3498db; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üì¶ Add Inventory</a>
    <a href="inventory-list.html" style="background: #2c3e50; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üìã Inventory List</a>
    <a href="batch.html" style="background: #9b59b6; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üìã Batch Management</a>
    <a href="active-inventory.html" style="background: #27ae60; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">‚úÖ Active Stock</a>
    <a href="onhold-inventory.html" style="background: #f39c12; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">‚è∏Ô∏è On-Hold Stock</a>
    <a href="billing.html" style="background: #e67e22; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üí∞ Billing</a>
    <a href="activate.html" style="background: #1abc9c; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üîÑ Activate</a>
    <a href="audit.html" style="background: #6f42c1; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üîç Audit</a>
    <a href="add-product.html" style="background: #17a2b8; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">‚ûï Add Product</a>
    <a href="metrics.html" style="background: #8e44ad; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">üìä Metrics</a>
  </div>
</nav>

<div class="kpi-cards">
<div class="kpi"><h3>Total Products</h3><p id="totalProducts">0</p></div>
<div class="kpi"><h3>Active Stock</h3><p id="activeStock">0</p></div>
<div class="kpi"><h3>On-Hold Stock</h3><p id="holdStock">0</p></div>
<div class="kpi"><h3>Total Revenue</h3><p id="totalRevenue">‚Çπ0</p></div>
<div class="kpi"><h3>Total Bills</h3><p id="totalBills">0</p></div>
</div>

<div class="section">
<h2>Inventory</h2>
<table id="inventoryTable">
<thead>
<tr>
<th>Name</th>
<th>Variant</th>
<th>Class</th>
<th>Brand</th>
<th>Total Qty</th>
<th>On-Hold</th>
<th>Active</th>
<th>Price</th>
<th>Shelf</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="section">
<h2>Sales Trends</h2>
<div class="trend-buttons">
<button data-period="daily">Daily</button>
<button data-period="weekly">Weekly</button>
<button data-period="monthly">Monthly</button>
<button data-period="yearly">Yearly</button>
</div>
<canvas id="salesChart"></canvas>
<canvas id="topProductsChart"></canvas>
<div id="customerStats"></div>
</div>

<div class="section">
<h2>Recent Bills</h2>
<table id="billsTable">
<thead>
<tr>
<th>Bill ID</th>
<th>Customer</th>
<th>Total</th>
<th>Date</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script type="module">
import { supabase } from './src/database.js'

let salesChartInstance, topChartInstance

async function loadKPIs() {
  const { data: products } = await supabase().from('products').select('*')
  const { data: sales, error: salesError } = await supabase().from('sales').select('price_at_sale, quantity_sold')
  const { data: inventory } = await supabase().from('inventory').select('quantity_active, quantity_on_hold')
  
  console.log('Sales data:', sales)
  console.log('Sales error:', salesError)
  
  document.getElementById('totalProducts').textContent = products.length
  document.getElementById('activeStock').textContent = inventory.reduce((sum,i)=>sum+(i.quantity_active||0),0)
  document.getElementById('holdStock').textContent = inventory.reduce((sum,i)=>sum+(i.quantity_on_hold||0),0)
  document.getElementById('totalRevenue').textContent = '‚Çπ'+sales.reduce((sum,s)=>sum+(s.price_at_sale * s.quantity_sold||0),0).toFixed(2)
  document.getElementById('totalBills').textContent = sales.length
}

async function loadInventory() {
  const { data: inventory } = await supabase().from('inventory_summary').select('*')
  const tbody = document.querySelector('#inventoryTable tbody')
  tbody.innerHTML = ''
  inventory.forEach(item=>{
    const row = document.createElement('tr')
    row.innerHTML = `
      <td>${item.part_name}</td>
      <td>${item.variant}</td>
      <td>${item.class||'-'}</td>
      <td>${item.brand}</td>
      <td>${item.total_quantity}</td>
      <td>${item.total_on_hold}</td>
      <td>${item.total_active}</td>
      <td>‚Çπ${item.price}</td>
      <td>${item.shelf_code||'-'}</td>
      <td><button onclick="deleteProduct('${item.product_id}')">Delete</button></td>
    `
    tbody.appendChild(row)
  })
}

window.deleteProduct = async (id)=>{
  if(!confirm("Delete product and all its inventory?")) return
  // Delete from inventory first (due to foreign key constraints)
  await supabase().from('inventory').delete().eq('product_id',id)
  // Then delete the product
  await supabase().from('products').delete().eq('id',id)
  loadInventory()
  loadKPIs()
}

async function loadSales(period){
  const now = new Date()
  let from
  if(period==='daily') from=new Date(now.getFullYear(),now.getMonth(),now.getDate()-1)
  if(period==='weekly') from=new Date(now.getFullYear(),now.getMonth(),now.getDate()-7)
  if(period==='monthly') from=new Date(now.getFullYear(),now.getMonth()-1,now.getDate())
  if(period==='yearly') from=new Date(now.getFullYear()-1,now.getMonth(),now.getDate())
  const { data: sales } = await supabase().from('sales').select('price_at_sale, quantity_sold, created_at').gte('created_at',from.toISOString())
  const dailyTotals = {}
  sales.forEach(s=>{
    const d = new Date(s.created_at).toLocaleDateString('en-IN')
    const saleAmount = s.price_at_sale * s.quantity_sold
    dailyTotals[d] = (dailyTotals[d]||0) + saleAmount
  })
  const labels = Object.keys(dailyTotals)
  const values = Object.values(dailyTotals)
  if(salesChartInstance) salesChartInstance.destroy()
  salesChartInstance = new Chart(document.getElementById('salesChart'),{
    type:'line',
    data:{ labels, datasets:[{ label:`${period.charAt(0).toUpperCase()+period.slice(1)} Sales`, data: values, borderColor:'#333', backgroundColor:'rgba(0,0,0,0.1)', fill:true }] }
  })
}

async function loadTopSelling() {
  const { data: sales } = await supabase().from('sales').select('product_id,quantity_sold')
  const tally = {}
  sales.forEach(s=>{ tally[s.product_id] = (tally[s.product_id]||0) + s.quantity_sold })
  const ids = Object.keys(tally)
  const { data: products } = await supabase().from('products').select('id,part_name,variant')
  const labels = []
  const values = []
  ids.forEach(id=>{
    const p = products.find(x=>x.id===id)
    labels.push(`${p?.part_name||'Unknown'} (${p?.variant||''})`)
    values.push(tally[id])
  })
  if(topChartInstance) topChartInstance.destroy()
  topChartInstance = new Chart(document.getElementById('topProductsChart'),{
    type:'bar',
    data:{ labels, datasets:[{ label:'Top Selling Items', data: values, backgroundColor:'#333' }] }
  })
}


async function loadCustomers() {
  // Get customer data directly from bills table
  const { data: bills } = await supabase().from('bills').select('customer_phone')
  const countMap = {}
  bills.forEach(bill => {
    const phone = bill.customer_phone || 'Unknown'
    countMap[phone] = (countMap[phone] || 0) + 1
  })
  const sorted = Object.entries(countMap).sort((a,b) => b[1] - a[1])
  document.getElementById('customerStats').innerHTML = `<h3>Customer Visits</h3><ul>${sorted.map(([phone,count]) => `<li>${phone} ‚Äì ${count} visits</li>`).join('')}</ul>`
}

async function loadRecent() {
  // First, get recent bills directly from the bills table
  const { data: bills, error: billsError } = await supabase()
    .from('bills')
    .select('*')
    .order('created_at', {ascending: false})
    .limit(10)
  
  console.log('Recent bills data:', bills)
  console.log('Recent bills error:', billsError)
  
  const tbody = document.querySelector('#billsTable tbody')
  tbody.innerHTML = ''
  
  if (bills && bills.length > 0) {
    bills.forEach(bill => {
      const date = new Date(bill.created_at).toLocaleString('en-IN')
      const row = document.createElement('tr')
      row.innerHTML = `
        <td>${bill.id}</td>
        <td>${bill.customer_name || 'Unknown'} (${bill.customer_phone || '-'})</td>
        <td>‚Çπ${bill.total_amount?.toFixed(2) || '0.00'}</td>
        <td>${date}</td>
      `
      tbody.appendChild(row)
    })
  } else {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No recent bills found</td></tr>'
  }
}

document.querySelectorAll('.trend-buttons button').forEach(btn=>{
  btn.addEventListener('click',()=> loadSales(btn.getAttribute('data-period')))
})

loadKPIs()
loadInventory()
loadSales('daily')
loadTopSelling()
loadCustomers()
loadRecent()

// Set current user
document.getElementById('currentUser').textContent = sessionStorage.getItem('rubyAutoPartsUser') || 'admin';
</script>
</body>
</html>